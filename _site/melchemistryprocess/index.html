<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MEL Chemistry Process</title>
    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/bootstrap.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="padding-left: 30px; padding-top: 30px; padding-right: 30px;">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="https://docs.google.com/spreadsheets/d/1WqwknAu_mwQfkDtP4UcGZAix2zBwqUmp3A8XX5xUto8/edit#gid=448918918" target="_blank">Google Sheet</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li style="color: #E0E0E0;"><a href="images/processdiagram.png">Diagram</a></li>
            <li style="color: #E0E0E0;">Set: <select id="selection_set" style="color: black; margin-right: 30px; margin-bottom: 0px; margin-top: 15px;"></select></li>
            <li style="color: #E0E0E0;">Responsible: <select id="selection_responsible" style="color: black; margin-bottom: 0px; margin-top: 15px;"></select></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<style>
table.donetasktable td {color: #A0A0A0;}
h2 {margin-top: 50px;}
.sample_row {display:none;}
</style>

<div class="container-fluid" style="padding-top: 30px;">

<div id="first_todo_task" class="jumbotron" style="padding: 20px 20px 20px 20px; position: relative; display:none;">
  <div style="position: absolute; left: 0px; top: 0px; z-index: 10; display: block; border-bottom-right-radius: 3px; padding-top: 5px; padding-left: 5px;"><p>Next task:</p></div>
  <h1 class="field_shortstring"></h1>
  <p style="margin-top: 0x; margin-bottom: 0px">Set: <span class="field_set"></span> | Responsible: <span class="field_responsible"></span></p>
  <p style="margin-top: 3x; margin-bottom: 0px">Description: <span class="field_description"></span></p>
  <p style="margin-top: 3x; ">Results: <span class="field_results"></span></p>
  <p>
    <button class="btn btn-primary btn-lg" id="button_start">Start</button>
    <button class="btn btn-primary btn-lg" id="button_finish" disabled="disabled">Finish</button>
    <span id="time_start" style="font-size: 40px; font-family: Courier; margin-left: 100px;"></span>&#9;
    <span id="time_finish" style="font-size: 40px; font-family: Courier; margin-left: 50px;"></span>
  </p>
</div><!--#first_task-->

<div id="first_blocked_task" class="jumbotron" style="padding: 20px 20px 20px 20px; position: relative; display:none;">
  <div style="position: absolute; left: 0px; top: 0px; z-index: 10; display: block; border-bottom-right-radius: 3px; padding-top: 5px; padding-left: 5px;"><p>No tasks with this filter. Next blocked task:</p></div>
  <h1 style="color: #A0A0A0" class="field_shortstring"></h1>
  <p style="margin-top: 0x; margin-bottom: 0px">Set: <span class="field_set"></span> | Responsible: <span class="field_responsible"></span></p>
  <h3>Blocked by:</h3>
  <p><span class="field_blockedby"></span></p>
</div>

<h2>To do</h2>

<table id="todo_tasks" cellpadding="0" cellspacing="0" class="table table-bordered" style="width: 840px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
  </tr>
  <tr class="task_row sample_row">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
  </tr>
</table>

<h2>Done</h2>

<table id="done_tasks" cellpadding="0" cellspacing="0" class="donetasktable table table-bordered" style="width: 920px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
    <th style="width:80px">time</th>
  </tr>
  <tr class="task_row sample_row">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
    <td class="field_totaltime"></td>
  </tr>
</table>

<h2>Blocked</h2>

<table id="blocked_tasks" cellpadding="0" cellspacing="0" class="table table-bordered" style="width: 1490px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
    <th style="width:650px">blocked by</th>
  </tr>
  <tr class="task_row sample_row">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
    <td class="field_blockedby"></td>
  </tr>
</table>

<script>

var tasks = [];
var filterResponsible = "Kostya";
var filterSet = "Kostya";
var taskFields = ["set", "id", "dependency", "type", "experiment", "name", "description", "results", "responsible", "control", "status", "starttime", "endtime", "totaltime"];

function parseJson(json) {
  var tasks = [];
  for (var i=0; i<json.feed.entry.length; i++) {
    tasks[i] = {};
    for (var p=0; p<taskFields.length; p++) {
      var field = taskFields[p];
      tasks[i][field] = json.feed.entry[i]["gsx$"+field]["$t"];
    }
  }
  return tasks;
}
                       
function getTaskById(id, set, experiment) {
  var arr = [];
  for (var i=0; i<tasks.length; i++) {
    var task = tasks[i];
    if (task["id"]==id && 
        task["set"]==set && 
        (experiment=="" || task["experiment"]=="" || task["experiment"]==experiment)
    ) {
      arr.push(task);
    }
  }
  return arr;
}

function isTaskReadyToStart(task) {
  var allDepReady = true;
  for (var i=0; i<task["dependency"].length; i++) {
    var dep = task["dependency"][i];
    if (dep!=null) {
      if (dep["status"]!="done") {
        allDepReady = false;
      }
    }
  }
  return allDepReady;
}

function populateTaskData(container, task) {
  for (var field in task) {
    if (task.hasOwnProperty(field)) {
      $(container).find(".field_"+field).html(task[field]);
    }
  }
}

function addTaskToTable(table, task, id) {
  var copy = $(table).find(".sample_row").clone();
  $(copy).removeClass("sample_row");
  copy.show();
  populateTaskData(copy, task);
  $(copy).attr("id", "task_" + id);
  $(table).append(copy); 
}

function addTodoTask(task, id) {
  addTaskToTable($("#todo_tasks"), task, id);
}

function addDoneTask(task, id) {
  addTaskToTable($("#done_tasks"), task, id);
}

function addBlockedTask(task, id, blockedby) {
  task["blockedby"] = blockedby;
  addTaskToTable($("#blocked_tasks"), task, id);
}

function addFirstTodoTask(task) {
  $("#first_todo_task").show();
  populateTaskData($("#first_todo_task"), task);
}

function addFirstBlockedTask(task, descriptionOfBlockingTasks) {
  $("#first_blocked_task").show();
  task["blockedby"] = descriptionOfBlockingTasks;
  populateTaskData($("#first_blocked_task"), task);
}

function isFilterMatched(task) {
  return (filterResponsible=="" || task["responsible"]==filterResponsible) &&
         (filterSet=="" || task["set"]==filterSet);
}

function getDescriptionOfTasksBlockingThis(task) {
  var blockedStr = "";
  for (var j=0; j<task["dependency"].length; j++) {
    var dep = task["dependency"][j];
    if (dep["status"] != "done") {
      blockedStr = blockedStr + dep["shortstring"] + "<br>";
    }
  }
  return blockedStr;
}

function buildTaskList(tasks) {
  $("#first_task_container").hide();
  var firstFlag = true;
  var firstBlocked = null;
  var blockerItems = [];
  for (var i=0; i<tasks.length; i++) {
    var task = tasks[i];
    if (isFilterMatched(task)) {
      if (task["status"]=="done") {
        addDoneTask(task, i);
      } else {
        if (isTaskReadyToStart(task)) {
          addTodoTask(task, i);
          if (firstFlag) {
            addFirstTodoTask(task, i);
            firstFlag = false;
          }
        } else {          
          addBlockedTask(task, i, getDescriptionOfTasksBlockingThis(task));
          if (firstBlocked==null) {
            firstBlocked = task;
          }
        }
      }
    }
  }

  if (firstFlag && firstBlocked!=null) {
    addFirstBlockedTask(firstBlocked, getDescriptionOfTasksBlockingThis(firstBlocked));
  }
}

function addToSet(arr, s) {
  arr[s] = 1;
}

function addSetToSelect(set, selectId, selectedElement) {
  var select = document.getElementById(selectId);

  //Adding "all"
  var opt = document.createElement("option");
  opt.value = "All";
  opt.innerHTML = "All";
  if (typeof selectedElement === "undefined" || selectedElement=="" || selectedElement==null) {
    opt.selected = true;
  }
  select.appendChild(opt);

  //Adding other options
  for (var s in set) {
    if (set.hasOwnProperty(s)) {
      var opt = document.createElement("option");
      opt.value = s;
      opt.innerHTML = s;
      if (s==selectedElement) {
        opt.selected = true;
      }
      select.appendChild(opt);
    }
  }
}

function fillSelections(tasks) {
  var sets = {};
  var responsibles = {};
  for (var i=0; i<tasks.length; i++) {
    addToSet(sets, tasks[i]["set"]);
    addToSet(responsibles, tasks[i]["responsible"]);
  }
  addSetToSelect(sets, "selection_set", filterSet);
  addSetToSelect(responsibles, "selection_responsible", filterResponsible);
}

function updatePageContent() {
  $("#todo_tasks").find(".task_row").not(".sample_row").remove();
  $("#done_tasks").find(".task_row").not(".sample_row").remove();
  $("#blocked_tasks").find(".task_row").not(".sample_row").remove();
  $("#first_blocked_task").hide();
  $("#first_todo_task").hide();
  buildTaskList(tasks);
}

$("#selection_set").on("change", function() {
  if (""+this.value=="All") {
    filterSet = "";
  } else {
    filterSet = ""+this.value;
  }
  $.cookie("filter_set", filterSet);
  updatePageContent();
});

$("#selection_responsible").on("change", function() {
  if (""+this.value=="All") {
    filterResponsible = "";
  } else {
    filterResponsible = ""+this.value;
  }
  $.cookie("filter_responsible", filterResponsible);
  updatePageContent();
});

$(document).ready(function(){

$("#button_start").click(function(){
  var currentdate = new Date(); 
  var startTimeStr = currentdate.getHours() + ":" + currentdate.getMinutes();
  $("#time_start").html(startTimeStr);
  $("#button_start").attr('disabled','disabled');
  $("#button_finish").removeAttr("disabled");
});

$("#button_finish").click(function(){
  var currentdate = new Date(); 
  var startTimeStr = $("#time_start").html();
  var finishTimeStr = currentdate.getHours() + ":" + currentdate.getMinutes();
  $("#time_finish").html(finishTimeStr);
  $("#button_start").removeAttr("disabled");
  $("#button_finish").attr('disabled','disabled');
  window.prompt("Paste time to Google Sheet: Ctrl+C, Enter", "done\t" + startTimeStr + "\t" + finishTimeStr);
});

});

function getTaskShortString(task) {
  if (task["experiment"]!="") {
    return "#" + task["id"] + " " + task["name"] + " [" + task["experiment"] + "]" + " - " + task["responsible"];
  } else {
    return "#" + task["id"] + " " + task["name"] + " - " + task["responsible"];
  }
}

function processTasks(tasks) {
  for (var i=0; i<tasks.length; i++) {
    var task = tasks[i];
    processTaskDependency(task);
    task["shortstring"] = getTaskShortString(task);
  }
}

function processTaskDependency(task) {
  var arrDepTasks = [];
  var arrDepIds = task["dependency"].split(", ");
  for (var j=0; j<arrDepIds.length; j++) {
    var id = arrDepIds[j];
    $.merge(arrDepTasks, getTaskById(id, task["set"], task["experiment"]));
  }
  task["dependency"] = arrDepTasks;
}

function importGSS(json) {
  filterResponsible = $.cookie("filter_responsible");
  filterSet = $.cookie("filter_set");

  tasks = parseJson(json);
  processTasks(tasks);

  fillSelections(tasks);
  buildTaskList(tasks);
}
</script>


<script src="https://spreadsheets.google.com/feeds/list/1WqwknAu_mwQfkDtP4UcGZAix2zBwqUmp3A8XX5xUto8/o7f9vto/public/values?alt=json-in-script&callback=importGSS"></script>

</div> <!-- /container -->

</body>
</html>