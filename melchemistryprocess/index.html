<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MEL Chemistry Process</title>
    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/melprocess.js"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body style="padding-left: 30px; padding-top: 30px; padding-right: 30px;">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li style="color: #E0E0E0;"><a href="https://docs.google.com/spreadsheets/d/1WqwknAu_mwQfkDtP4UcGZAix2zBwqUmp3A8XX5xUto8/edit#gid=448918918" target="_blank">Google Sheet</a></li>
            <li style="color: #E0E0E0;" class="active"><a href="index.html">Table</a></li>
            <li style="color: #E0E0E0;"><a href="diagram.html">Diagram</a></li>
            <li style="color: #E0E0E0;"><span style="margin-left: 30px;">Set: </span><select id="selection_set" style="color: black; margin-right: 30px; margin-bottom: 0px; margin-top: 15px;"></select></li>
            <li style="color: #E0E0E0;">Responsible: <select id="selection_responsible" style="color: black; margin-bottom: 0px; margin-top: 15px;"></select></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

<style>
table.donetasktable td {color: #A0A0A0;}
h2 {margin-top: 50px;}
.sample_task {display:none;}
</style>

<div class="container-fluid" style="padding-top: 30px;">

<div id="first_todo_task" class="jumbotron" style="padding: 20px 20px 20px 20px; position: relative; display:none;">
  <div style="position: absolute; left: 0px; top: 0px; z-index: 10; display: block; border-bottom-right-radius: 3px; padding-top: 5px; padding-left: 5px;"><p>Next task:</p></div>
  <h1 class="field_shortstring"></h1>
  <p style="margin-top: 0x; margin-bottom: 0px">Set: <span class="field_set"></span> | Responsible: <span class="field_responsible"></span></p>
  <p style="margin-top: 3x; margin-bottom: 0px">Description: <span class="field_description"></span></p>
  <p style="margin-top: 3x; ">Results: <span class="field_results"></span></p>
  <p>
    <button class="btn btn-primary btn-lg" id="button_start">Start</button>
    <button class="btn btn-primary btn-lg" id="button_finish" disabled="disabled">Finish</button>
    <span id="time_start" style="font-size: 40px; font-family: Courier; margin-left: 100px;"></span>&#9;
    <span id="time_finish" style="font-size: 40px; font-family: Courier; margin-left: 50px;"></span>
  </p>
</div><!--#first_task-->

<div id="first_blocked_task" class="jumbotron" style="padding: 20px 20px 20px 20px; position: relative; display:none;">
  <div style="position: absolute; left: 0px; top: 0px; z-index: 10; display: block; border-bottom-right-radius: 3px; padding-top: 5px; padding-left: 5px;"><p>No tasks with this filter. Next blocked task:</p></div>
  <h1 style="color: #A0A0A0" class="field_shortstring"></h1>
  <p style="margin-top: 0x; margin-bottom: 0px">Set: <span class="field_set"></span> | Responsible: <span class="field_responsible"></span></p>
  <h3>Blocked by:</h3>
  <p><span class="field_blockedby"></span></p>
</div>

<h2>To do</h2>

<table id="todo_tasks" cellpadding="0" cellspacing="0" class="table table-bordered" style="width: 940px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
    <th style="width:100px"></th>
  </tr>
  <tr class="task_row sample_task">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
    <td><button class="start_button" class="btn btn-primary">Start</button></td>
  </tr>
</table>

<h2>Blocked</h2>

<table id="blocked_tasks" cellpadding="0" cellspacing="0" class="table table-bordered" style="width: 1490px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
    <th style="width:650px">blocked by</th>
  </tr>
  <tr class="task_row sample_task">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
    <td class="field_blockedby"></td>
  </tr>
</table>

<h2>Done</h2>

<table id="done_tasks" cellpadding="0" cellspacing="0" class="donetasktable table table-bordered" style="width: 920px;">
  <tr>
    <th style="width:40px">id</th>
    <th style="width:80px">set</th>
    <th style="width:150px">experiment</th>
    <th style="width:450px">name</th>
    <th style="width:120px">responsible</th>
    <th style="width:80px">time</th>
  </tr>
  <tr class="task_row sample_task">
    <td class="field_id"></td>
    <td class="field_set"></td>
    <td class="field_experiment"></td>
    <td class="field_name"></td>
    <td class="field_responsible"></td>
    <td class="field_totaltime"></td>
  </tr>
</table>

<!-- Modal -->
<div class="modal fade" id="finish_task_dialog" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Task finished</h4>
      </div>
      <div class="modal-body">
        <h4>Task finished</h4>
        <div id="finished_task">
          <span class="field_shortstring"></span>

          <h4 style="margin-top: 30px;">Needed actions</h4>
          <ol>
            <li>Make sure files are put in right places if needed<br><span style="color: blue;">Result: <span class="field_results"></span></span></li>
            <li>Copy the following text <input type="text" size="20" class="field_pastestring"></input> and paste it to <a href="https://docs.google.com/spreadsheets/d/1WqwknAu_mwQfkDtP4UcGZAix2zBwqUmp3A8XX5xUto8/edit#gid=448918918" target="_blank">Google Sheet</a> to row <span class="field_index"></span></li>
            <li>Owners of released tasks will be notified by email</li>
            <li>Refresh the page and start the next task</li>
          </ol>

        </div>

        <h4 style="margin-top: 30px;">The following tasks are now released and ready to do</h4>
        <div id="released_tasks">
          <ul class="sample_task">
            <li class="field_shortstring"></li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>

var melTasks = {};
var firstTodoTask = null;

function showFinishTasksDialog() {
  var releasedTasks = firstTodoTask.getTasksReleasedAfterThatIsDone();

  firstTodoTask.populateTaskData($("#finished_task"));

  //Prepare string to paste
  var currentdate = new Date(); 
  var startTimeStr = $("#time_start").html();
  var finishTimeStr = convertNumberToTwoDigitString(currentdate.getHours()) + ":" + convertNumberToTwoDigitString(currentdate.getMinutes());
  $("#time_finish").html(finishTimeStr);
  $("#button_start").removeAttr("disabled");
  $("#button_finish").attr('disabled','disabled');
  $("#finished_task").find(".field_pastestring").val("done\t" + startTimeStr + "\t" + finishTimeStr);

  //Released tasks
  for (var i=0; i<releasedTasks.length; i++) {
    var releasedTask = releasedTasks[i];
    var copy = $("#released_tasks").find(".sample_task").clone();
    $(copy).removeClass("sample_task");
    copy.show();
    releasedTask.populateTaskData(copy);
    $("#released_tasks").append(copy); 
  }

  $('#finish_task_dialog').on('shown.bs.modal', function (e) {
    $("#finished_task").find(".field_pastestring").focus();
    $("#finished_task").find(".field_pastestring").select();
  });

  //Send emails
  for (var i=0; i<releasedTasks.length; i++) {
    var releasedTask = releasedTasks[i];
    melPeople.sendEmail(releasedTask.responsible, releasedTask);
  }

  $('#finish_task_dialog').modal();
}

function addTaskToTable(table, task) {
  var copy = $(table).find(".sample_task").clone();
  $(copy).removeClass("sample_task");
  copy.show();
  task.populateTaskData(copy);
  $(copy).find(".start_button").click(function(){
    addFirstTodoTask(task);
    startFirstTaskTimer();
  });
  $(copy).attr("id", "task_" + task.index);
  $(table).append(copy); 
}

function addFirstTodoTask(task) {
  firstTodoTask = task;
  $("#first_todo_task").show();
  task.populateTaskData($("#first_todo_task"));
}

function addFirstBlockedTask(task) {
  $("#first_blocked_task").show();
  task.populateTaskData($("#first_blocked_task"));
}

function buildTaskList(tasks) {
  $("#first_task_container").hide();
  var firstFlag = true;
  var firstBlocked = null;
  var blockerItems = [];
  for (var i=0; i<tasks.length; i++) {
    var task = tasks[i];
    if (melFilter.isTaskMatched(task)) {
      if (task.isDone()) {
        addTaskToTable($("#done_tasks"), task);
      } else {
        if (task.isReadyToStart()) {
          addTaskToTable($("#todo_tasks"), task);
          if (firstFlag) {
            addFirstTodoTask(task);
            firstFlag = false;
          }
        } else {          
          addTaskToTable($("#blocked_tasks"), task);
          if (firstBlocked==null) {
            firstBlocked = task;
          }
        }
      }
    }
  }

  if (firstFlag && firstBlocked!=null) {
    addFirstBlockedTask(firstBlocked);
  }
}

function fillSelections(tasks) {
  melFilter.fillOptionsFromTasks(tasks);
  melFilter.populateSetOptions("selection_set", updatePageContent);
  melFilter.populateResponsibleOptions("selection_responsible", updatePageContent);
}

function updatePageContent() {
  $("#todo_tasks").find(".task_row").not(".sample_task").remove();
  $("#done_tasks").find(".task_row").not(".sample_task").remove();
  $("#blocked_tasks").find(".task_row").not(".sample_task").remove();
  $("#first_blocked_task").hide();
  $("#first_todo_task").hide();
  buildTaskList(melTasks.tasks);
}

function convertNumberToTwoDigitString(n) {
  if (n>9) {
    return "" + n;
  } else {
    return "0" + n;
  }
}

function startFirstTaskTimer() {
  var currentdate = new Date(); 
  var startTimeStr = convertNumberToTwoDigitString(currentdate.getHours()) + ":" + convertNumberToTwoDigitString(currentdate.getMinutes());
  $("#time_start").html(startTimeStr);
  $("#button_start").attr('disabled','disabled');
  $("#button_finish").removeAttr("disabled");
}

$(document).ready(function(){

$("#button_start").click(function(){
  startFirstTaskTimer();
});

$("#button_finish").click(function(){
  showFinishTasksDialog();
});

});

function importGSS(json) {
  melTasks = new MelTaskList(json);
  fillSelections(melTasks.tasks);
  buildTaskList(melTasks.tasks);
}
</script>


<script src="https://spreadsheets.google.com/feeds/list/1WqwknAu_mwQfkDtP4UcGZAix2zBwqUmp3A8XX5xUto8/o7f9vto/public/values?alt=json-in-script&callback=importGSS"></script>

</div> <!-- /container -->

</body>
</html>